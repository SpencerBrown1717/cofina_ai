<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofina.AI - Intelligent CFO Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            color: var(--dark);
            background: var(--light-bg);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--white);
            border-right: 1px solid var(--gray-light);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 2rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--gray);
            text-decoration: none;
            border-radius: var(--radius);
            font-weight: 500;
        }

        .nav-link.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-link:hover {
            background: var(--light-bg);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .date-filter {
            display: flex;
            align-items: center;
            background: var(--white);
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: var(--white);
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .metric-title {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }

        .metric-change.positive {
            color: var(--success);
        }

        .metric-change.negative {
            color: var(--danger);
        }

        /* Charts */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--white);
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-btn {
            background: none;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .chart-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chart-container {
            height: 250px;
            position: relative;
        }

        /* Cash Flow Chart */
        .cash-flow-chart {
            height: 100%;
            width: 100%;
        }

        .axis-line {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 1px;
            background: var(--gray-light);
        }

        .chart-y-axis {
            position: absolute;
            left: 0;
            top: 20px;
            bottom: 30px;
            width: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 2;
        }

        .chart-y-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-align: right;
        }

        .chart-bars {
            display: flex;
            height: 200px;
            align-items: flex-end;
            justify-content: space-between;
            padding-top: 20px;
            position: relative;
        }

        .bar-group {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            width: 60px;
            justify-content: center;
            gap: 4px;
        }

        .bar {
            width: 20px;
            border-radius: 4px 4px 0 0;
            margin: 0;
            position: relative;
            transition: box-shadow 0.2s;
        }

        .bar.income {
            background: #10b981;
        }

        .bar.expense {
            background: #ef4444;
        }

        .bar:hover, .bar:focus {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            outline: 2px solid var(--primary);
            z-index: 3;
        }

        .bar-tooltip {
            display: none;
            position: absolute;
            left: 50%;
            bottom: 110%;
            transform: translateX(-50%);
            background: var(--dark);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
        }

        .bar:hover .bar-tooltip, .bar:focus .bar-tooltip {
            display: block;
        }

        .bar-label {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 0.5rem;
        }

        /* Burn Rate Chart */
        .burn-rate-chart {
            position: relative;
            height: 100%;
        }

        .line-chart {
            height: 200px;
            position: relative;
        }

        .chart-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gray-light);
        }

        .chart-line-label {
            position: absolute;
            left: 0;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
            z-index: 1;
        }

        .line.danger {
            background: var(--danger);
            height: 1px;
            border-top: 1px dashed var(--danger);
        }

        .dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            z-index: 2;
        }

        /* AI Chat */
        .chat-container {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 400px;
        }

        .chat-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: 1.25rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
        }

        .message.user {
            margin-left: auto;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
        }

        .message.ai .message-content {
            background: var(--light-bg);
        }

        .message.user .message-content {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .chat-input {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-light);
            display: flex;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
        }

        .chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0 1rem;
            margin-left: 0.5rem;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--gray-light);
                padding: 1rem;
            }

            .logo {
                margin-bottom: 1rem;
            }

            .nav-menu {
                display: flex;
                overflow-x: auto;
                margin: 0 -1rem;
                padding: 0 1rem;
            }

            .nav-item {
                margin-bottom: 0;
                margin-right: 0.5rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">Cofina.AI</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link active">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">Transactions</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">Reports</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">Forecast</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">Integrations</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">Settings</a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="title">Financial Dashboard</h1>
                <div class="date-filter" id="dateFilter">Last 30 Days ▼</div>
            </div>

            <!-- Key Metrics -->
            <div class="dashboard-grid">
                <div class="metric-card">
                    <h3 class="metric-title">CURRENT CASH</h3>
                    <div class="metric-value">$243,675</div>
                    <div class="metric-change positive">+2.5% from last month</div>
                </div>
                <div class="metric-card">
                    <h3 class="metric-title">MONTHLY BURN RATE</h3>
                    <div class="metric-value">$67,890</div>
                    <div class="metric-change negative">+4.3% from last month</div>
                </div>
                <div class="metric-card">
                    <h3 class="metric-title">RUNWAY</h3>
                    <div class="metric-value">3.6 months</div>
                    <div class="metric-change negative">-0.3 months</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-row">
                <!-- Cash Flow Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Cash Flow</h3>
                        <div class="chart-controls">
                            <button class="chart-btn" data-period="weekly">Weekly</button>
                            <button class="chart-btn active" data-period="monthly">Monthly</button>
                            <button class="chart-btn" data-period="quarterly">Quarterly</button>
                        </div>
                    </div>
                    <div class="chart-container" style="position:relative;">
                        <div class="chart-y-axis" id="cashFlowYAxis"></div>
                        <div class="cash-flow-chart">
                            <div class="chart-bars" id="cashFlowChart">
                                <!-- Chart bars will be dynamically generated -->
                            </div>
                            <div class="axis-line"></div>
                        </div>
                    </div>
                </div>

                <!-- Burn Rate Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Burn Rate Trend</h3>
                        <div class="chart-controls">
                            <button class="chart-btn active" data-period="6m">6M</button>
                            <button class="chart-btn" data-period="1y">1Y</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="burn-rate-chart" id="burnRateChart">
                            <!-- Burn rate chart will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Chat -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">Financial AI Assistant</div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <div class="message-content">
                            Hello! I'm your financial AI assistant. I can help you understand your financial data, analyze trends, and answer questions about your business finances. What would you like to know today?
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Ask anything about your financial data...">
                    <button id="sendButton">Send</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Sample data for charts
        const cashFlowData = {
            monthly: [
                { month: 'Jan', income: 120, expense: 80, net: 40 },
                { month: 'Feb', income: 140, expense: 100, net: 40 },
                { month: 'Mar', income: 100, expense: 110, net: -10 },
                { month: 'Apr', income: 130, expense: 90, net: 40 },
                { month: 'May', income: 150, expense: 95, net: 55 },
                { month: 'Jun', income: 110, expense: 85, net: 25 }
            ],
            weekly: [
                { week: 'W1', income: 30, expense: 20, net: 10 },
                { week: 'W2', income: 35, expense: 25, net: 10 },
                { week: 'W3', income: 25, expense: 28, net: -3 },
                { week: 'W4', income: 32, expense: 22, net: 10 }
            ],
            quarterly: [
                { quarter: 'Q1', income: 360, expense: 290, net: 70 },
                { quarter: 'Q2', income: 390, expense: 270, net: 120 }
            ]
        };

        const burnRateData = {
            '6m': [
                { month: 'Jan', rate: 65 },
                { month: 'Feb', rate: 68 },
                { month: 'Mar', rate: 70 },
                { month: 'Apr', rate: 72 },
                { month: 'May', rate: 75 },
                { month: 'Jun', rate: 78 }
            ],
            '1y': [
                { month: 'Jul', rate: 60 },
                { month: 'Aug', rate: 62 },
                { month: 'Sep', rate: 65 },
                { month: 'Oct', rate: 68 },
                { month: 'Nov', rate: 70 },
                { month: 'Dec', rate: 72 },
                { month: 'Jan', rate: 65 },
                { month: 'Feb', rate: 68 },
                { month: 'Mar', rate: 70 },
                { month: 'Apr', rate: 72 },
                { month: 'May', rate: 75 },
                { month: 'Jun', rate: 78 }
            ]
        };

        // Add CSS for animations and improved chart styling
        const style = document.createElement('style');
        style.textContent = `
            .bar {
                transition: height 0.3s ease-out, box-shadow 0.2s ease;
            }
            
            .bar:hover {
                box-shadow: 0 4px 16px rgba(0,0,0,0.12);
                outline: 2px solid var(--primary);
                z-index: 3;
            }

            .bar-tooltip {
                opacity: 0;
                transition: opacity 0.2s ease;
                pointer-events: none;
                background: var(--dark);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 0.75rem;
                white-space: nowrap;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }

            .bar:hover .bar-tooltip {
                opacity: 1;
            }

            .net-indicator {
                position: absolute;
                width: 100%;
                height: 2px;
                background: var(--primary);
                transition: top 0.3s ease-out;
            }

            .net-indicator.negative {
                background: var(--danger);
            }

            .chart-legend {
                display: flex;
                justify-content: center;
                gap: 1rem;
                margin-top: 1rem;
                font-size: 0.75rem;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .legend-color {
                width: 12px;
                height: 12px;
                border-radius: 2px;
            }

            .legend-color.income { background: var(--success); }
            .legend-color.expense { background: var(--danger); }
            .legend-color.net { background: var(--primary); }
        `;
        document.head.appendChild(style);

        // Add error handling for data loading
        function validateData(data) {
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid data structure');
            }
            
            const requiredPeriods = ['monthly', 'weekly', 'quarterly'];
            for (const period of requiredPeriods) {
                if (!Array.isArray(data[period])) {
                    throw new Error(`Missing or invalid ${period} data`);
                }
                
                data[period].forEach((item, index) => {
                    if (!item || typeof item !== 'object') {
                        throw new Error(`Invalid item at index ${index} in ${period} data`);
                    }
                    
                    const requiredFields = period === 'monthly' ? ['month', 'income', 'expense', 'net'] :
                                        period === 'weekly' ? ['week', 'income', 'expense', 'net'] :
                                        ['quarter', 'income', 'expense', 'net'];
                    
                    for (const field of requiredFields) {
                        if (!(field in item)) {
                            throw new Error(`Missing ${field} in ${period} data at index ${index}`);
                        }
                    }
                    
                    if (typeof item.income !== 'number' || typeof item.expense !== 'number' || typeof item.net !== 'number') {
                        throw new Error(`Invalid numeric values in ${period} data at index ${index}`);
                    }
                });
            }
        }

        // Initialize charts with error handling
        function initializeCharts() {
            try {
                // Validate data before rendering
                validateData(cashFlowData);
                validateData(burnRateData);
                
                // Render charts
                renderCashFlowChart('monthly');
                renderBurnRateChart('6m');
            } catch (error) {
                console.error('Error initializing charts:', error);
                // Show user-friendly error message
                const errorMessage = document.createElement('div');
                errorMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--danger);
                    color: white;
                    padding: 1rem;
                    border-radius: var(--radius);
                    box-shadow: var(--shadow);
                    z-index: 1000;
                `;
                errorMessage.textContent = 'Error loading charts. Please refresh the page.';
                document.body.appendChild(errorMessage);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    errorMessage.remove();
                }, 5000);
            }
        }

        // Improved chart rendering with error handling
        function renderCashFlowChart(period) {
            try {
                const chartContainer = document.getElementById('cashFlowChart');
                const yAxis = document.getElementById('cashFlowYAxis');
                
                if (!chartContainer || !yAxis) {
                    throw new Error('Required chart elements not found');
                }

                const data = cashFlowData[period];
                if (!data || !Array.isArray(data)) {
                    throw new Error('Invalid data format for cash flow chart');
                }

                // Clear previous content
                chartContainer.innerHTML = '';
                yAxis.innerHTML = '';
                
                // Calculate max value for scaling
                let max = 0;
                data.forEach(item => {
                    if (typeof item.income === 'number' && typeof item.expense === 'number') {
                        max = Math.max(max, item.income, item.expense);
                    }
                });
                
                if (max === 0) {
                    throw new Error('No valid data points found');
                }
                
                max = Math.ceil(max / 10) * 10;

                // Create Y-axis labels with error handling
                try {
                    for (let i = 5; i >= 0; i--) {
                        const label = document.createElement('div');
                        label.className = 'chart-y-label';
                        label.style.height = '40px';
                        label.textContent = `$${Math.round((max * i) / 5)}k`;
                        yAxis.appendChild(label);
                    }
                } catch (error) {
                    console.error('Error creating Y-axis labels:', error);
                    throw error;
                }

                // Create chart bars with error handling
                data.forEach((item, index) => {
                    try {
                        if (typeof item.income !== 'number' || typeof item.expense !== 'number') {
                            console.warn(`Skipping invalid data point at index ${index}`);
                            return;
                        }

                        const barGroup = document.createElement('div');
                        barGroup.className = 'bar-group';
                        barGroup.style.position = 'relative';
                        
                        // Income bar
                        const incomeBar = document.createElement('div');
                        incomeBar.className = 'bar income';
                        incomeBar.setAttribute('tabindex', '0');
                        incomeBar.style.height = '0';
                        const incomeTooltip = document.createElement('div');
                        incomeTooltip.className = 'bar-tooltip';
                        incomeTooltip.textContent = `Income: $${item.income}k`;
                        incomeBar.appendChild(incomeTooltip);
                        
                        // Expense bar
                        const expenseBar = document.createElement('div');
                        expenseBar.className = 'bar expense';
                        expenseBar.setAttribute('tabindex', '0');
                        expenseBar.style.height = '0';
                        const expenseTooltip = document.createElement('div');
                        expenseTooltip.className = 'bar-tooltip';
                        expenseTooltip.textContent = `Expense: $${item.expense}k`;
                        expenseBar.appendChild(expenseTooltip);

                        // Net indicator
                        const netIndicator = document.createElement('div');
                        netIndicator.className = `net-indicator ${item.net < 0 ? 'negative' : ''}`;
                        netIndicator.style.top = `${200 - (item.net / max) * 200}px`;
                        
                        // Label
                        const label = document.createElement('div');
                        label.className = 'bar-label';
                        label.textContent = period === 'monthly' ? item.month : period === 'weekly' ? item.week : item.quarter;
                        
                        // Append elements
                        barGroup.appendChild(incomeBar);
                        barGroup.appendChild(expenseBar);
                        barGroup.appendChild(netIndicator);
                        barGroup.appendChild(label);
                        chartContainer.appendChild(barGroup);

                        // Trigger animations with error handling
                        requestAnimationFrame(() => {
                            try {
                                incomeBar.style.height = `${(item.income / max) * 200}px`;
                                expenseBar.style.height = `${(item.expense / max) * 200}px`;
                            } catch (error) {
                                console.error('Error animating bars:', error);
                            }
                        });
                    } catch (error) {
                        console.error(`Error creating bar group at index ${index}:`, error);
                    }
                });

                // Add legend with error handling
                try {
                    const legend = document.createElement('div');
                    legend.className = 'chart-legend';
                    legend.innerHTML = `
                        <div class="legend-item">
                            <div class="legend-color income"></div>
                            <span>Income</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color expense"></div>
                            <span>Expense</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color net"></div>
                            <span>Net</span>
                        </div>
                    `;
                    chartContainer.appendChild(legend);
                } catch (error) {
                    console.error('Error creating legend:', error);
                }

            } catch (error) {
                console.error('Error rendering cash flow chart:', error);
                // Show error message in chart container
                chartContainer.innerHTML = `
                    <div style="
                        padding: 2rem;
                        text-align: center;
                        color: var(--danger);
                        font-size: 0.875rem;
                    ">
                        Error loading chart. Please try again.
                    </div>
                `;
            }
        }

        // Render Burn Rate Chart
        function renderBurnRateChart(period) {
            try {
                const chartContainer = document.getElementById('burnRateChart');
                if (!chartContainer) {
                    console.error('Burn rate chart container not found');
                    return;
                }

                const data = burnRateData[period];
                if (!data || !Array.isArray(data)) {
                    console.error('Invalid data format for burn rate chart');
                    return;
                }

                chartContainer.innerHTML = '';

                const lineChart = document.createElement('div');
                lineChart.className = 'line-chart';

                // Add reference lines
                [80, 60, 40].forEach((value, index) => {
                    const line = document.createElement('div');
                    line.className = 'chart-line';
                    line.style.top = `${40 + index * 60}px`;
                    
                    const label = document.createElement('span');
                    label.className = 'chart-line-label';
                    label.textContent = `$${value}k`;
                    
                    line.appendChild(label);
                    lineChart.appendChild(line);
                });

                // Add danger line
                const dangerLine = document.createElement('div');
                dangerLine.className = 'line danger';
                dangerLine.style.top = '70px';
                lineChart.appendChild(dangerLine);

                // Add data points and lines
                data.forEach((point, index) => {
                    if (typeof point.rate !== 'number') {
                        return;
                    }

                    const x = (index / (data.length - 1)) * 100;
                    const y = 200 - (point.rate * 2);

                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.style.left = `${x}%`;
                    dot.style.top = `${y}px`;
                    lineChart.appendChild(dot);

                    if (index < data.length - 1) {
                        const nextPoint = data[index + 1];
                        if (typeof nextPoint.rate !== 'number') {
                            return;
                        }

                        const nextX = ((index + 1) / (data.length - 1)) * 100;
                        const nextY = 200 - (nextPoint.rate * 2);

                        const line = document.createElement('div');
                        line.className = 'line';
                        line.style.left = `${x}%`;
                        line.style.width = `${nextX - x}%`;
                        line.style.top = `${y}px`;
                        line.style.transform = `rotate(${Math.atan2(nextY - y, nextX - x)}rad)`;
                        line.style.transformOrigin = 'left center';
                        lineChart.appendChild(line);
                    }
                });

                chartContainer.appendChild(lineChart);
            } catch (error) {
                console.error('Error rendering burn rate chart:', error);
            }
        }

        // Chat functionality
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');

        function addMessage(content, isUser = false) {
            if (!content || typeof content !== 'string') {
                console.error('Invalid message content');
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleSendMessage() {
            const message = chatInput.value.trim();
            if (!message) {
                return;
            }

            // Sanitize input
            const sanitizedMessage = message.replace(/[<>]/g, '');
            if (sanitizedMessage !== message) {
                console.warn('Message contained potentially unsafe characters');
            }

            addMessage(sanitizedMessage, true);
            chatInput.value = '';
            
            // Simulate AI response
            setTimeout(() => {
                const responses = [
                    "Based on your current financial data, I can see that your burn rate has increased by 4.3% this month. This is primarily due to increased marketing expenses and new hires.",
                    "Your runway is currently at 3.6 months. Would you like me to suggest some cost optimization strategies?",
                    "I notice that your cash flow has been positive for the last 3 months. Would you like to see a detailed breakdown of your income sources?",
                    "Your QuickBooks integration shows that accounts receivable have increased by 15% this quarter. This is a positive trend."
                ];
                addMessage(responses[Math.floor(Math.random() * responses.length)]);
            }, 1000);
        }

        // Add error handling for event listeners
        function addEventListeners() {
            try {
                document.querySelectorAll('.chart-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        try {
                            const period = e.target.dataset.period;
                            if (!period) {
                                throw new Error('No period specified for chart button');
                            }

                            const chartType = e.target.closest('.chart-card')?.querySelector('.chart-title')?.textContent.toLowerCase();
                            if (!chartType) {
                                throw new Error('Could not determine chart type');
                            }
                            
                            // Update active button
                            e.target.closest('.chart-controls')?.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            
                            // Update chart
                            if (chartType.includes('cash flow')) {
                                renderCashFlowChart(period);
                            } else if (chartType.includes('burn rate')) {
                                renderBurnRateChart(period);
                            }
                        } catch (error) {
                            console.error('Error handling chart button click:', error);
                        }
                    });
                });

                // Chat input handling
                const chatInput = document.getElementById('chatInput');
                const sendButton = document.getElementById('sendButton');
                
                if (chatInput && sendButton) {
                    sendButton.addEventListener('click', handleSendMessage);
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            handleSendMessage();
                        }
                    });
                } else {
                    console.error('Chat elements not found');
                }
            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        }

        // Initialize everything with error handling
        try {
            addEventListeners();
            initializeCharts();
        } catch (error) {
            console.error('Error initializing dashboard:', error);
        }
    </script>
</body>
</html> 